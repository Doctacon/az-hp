---
"id": "ah-6136"
"status": "closed"
"deps": []
"links": []
"created": "2026-02-17T18:56:57Z"
"type": "bug"
"priority": 1
"assignee": "Connor"
"parent": "ah-1494"
"tags":
- "sprint:fix-make-all"
"external": {}
---
# Fix 02_clip_arizona.py to skip empty/missing files

# Fix 02_clip_arizona.py to skip empty/missing files

## Objective Alignment
The clip step must complete successfully to unblock the enrich step. Currently it crashes on empty buildings file.

## Problem
The \`02_clip_arizona.py\` script fails completely when it encounters:
1. Empty parquet files (0 bytes) like \`overture_buildings_az.parquet\`
2. Missing parquet files like \`overture_places_az.parquet\`

This prevents the enrich step from running.

## Scope
- Modify \`clip_layer()\` function in \`pipeline/02_clip_arizona.py\` to:
  1. Check if file exists before reading
  2. Check if file is empty (0 bytes) before reading
  3. Skip with a warning message instead of crashing

## Non-goals
- Fix the underlying data download issues (separate ticket)
- Handle corrupt parquet files (just check for 0 bytes)

## Implementation Plan

1. Edit \`pipeline/02_clip_arizona.py\`
2. In the \`clip_layer()\` function, add checks:

\`\`\`python
def clip_layer(input_name: str, output_name: str, az_boundary: gpd.GeoDataFrame):
    input_path = RAW_DIR / f"{input_name}.parquet"
    output_path = PROCESSED_DIR / f"{output_name}.parquet"

    if not input_path.exists():
        print(f"  Skipping {input_name} (not found)")
        return
    
    if input_path.stat().st_size == 0:
        print(f"  Skipping {input_name} (empty file)")
        return
    
    # ... rest of function
\`\`\`

## Acceptance Criteria
- [ ] \`uv run python pipeline/02_clip_arizona.py\` completes without error
- [ ] Buildings layer is skipped with warning message
- [ ] Places layer is skipped with warning message (file doesn't exist)
- [ ] Other layers (transportation, water, land, land_cover, land_use) are clipped successfully

## Verification Commands
\`\`\`bash
# Clean processed dir
rm -rf data/processed/*

# Run clip step
uv run python pipeline/02_clip_arizona.py

# Verify expected files exist
ls -la data/processed/
\`\`\`

Expected output files:
- overture_transportation_clipped.parquet
- overture_land_clipped.parquet
- overture_land_cover_clipped.parquet
- overture_land_use_clipped.parquet
- overture_water_clipped.parquet

## Risks/Edge Cases
- Empty buildings/places may affect downstream tiles - acceptable for now, will be fixed in separate tickets

## Acceptance Criteria

make clip runs without error, skipping buildings and places layers

## Notes

**2026-02-17T19:21:13Z**

## Implementation Complete

Added check for empty files (0 bytes) in clip_layer() function.

### Verification Results
- Empty file: skipped with warning ✅
- Missing file: skipped with warning ✅
- Normal operation: all layers clipped ✅

### Commit
- SHA: 0258463
- Branch: team/ah-6136
