---
"id": "ah-2299"
"status": "closed"
"deps": []
"links": []
"created": "2026-02-20T14:54:52Z"
"type": "task"
"priority": 1
"assignee": "Connor"
"tags": []
"external": {}
---
# Optimize data pipeline performance

## Acceptance Criteria

Fresh pipeline run < 6 min; cached run < 3 min; no intermediate GeoJSON files > 100MB; parallel tile generation

## Notes

**2026-02-20T14:55:57Z**

## Implementation Plan

### Problem
Pipeline takes 10-15 min. Major bottlenecks:
1. Downloading unused Overture layers (water, landcover, buildings, land_use, land) - ~900MB
2. Converting parquet → GeoJSON for all layers - writes 3.7GB to disk
3. Running tippecanoe on unused layers (water, landcover, buildings) - ~5 min
4. No download caching - re-downloads on every run
5. Sequential tile generation

### Solution
1. Remove unused downloads (water, landcover, buildings, land_use, land, usfs_forests)
2. Stream parquet → tippecanoe via ogr2ogr (no intermediate GeoJSON)
3. Remove unused tile generation
4. Add file-existence caching for downloads
5. Parallelize tippecanoe runs

### Files to Change
- pipeline/01_download.py: Remove unused downloads, add caching
- pipeline/02_clip_arizona.py: Remove unused layers
- pipeline/04_generate_tiles.sh: Stream to tippecanoe, parallelize, remove unused

**2026-02-20T22:57:51Z**

## Benchmark Results

### Timing
| Scenario | Before | After | Savings |
|---|---|---|---|
| Fresh run (downloads + processing) | ~10-15 min | ~5-6 min | ~50-60% |
| Cached run (data exists) | ~10-15 min | ~2-3 min | ~80% |
| Download step (cached) | ~3-4 min | ~1.2 sec | 99% |
| Enrich step (cached) | ~2-3 min | ~2.8 sec | 98% |
| Tile generation | ~5-7 min | ~2 min | ~65% |

### Disk Savings
| Location | Before | After | Savings |
|---|---|---|---|
| data/raw/ | ~1GB | 298MB | ~700MB |
| data/processed/ | ~4GB | 503MB | ~3.5GB |
| **Total** | ~5GB | 801MB | **~4.2GB** |

### Changes Made
1. **01_download.py**: Removed unused downloads (water, landcover, buildings, land_use, land, usfs_forests), added file-existence caching
2. **02_clip_arizona.py**: Removed unused layers from clip list, added output caching
3. **03_enrich.py**: Added caching for enrich_roads() and filter_hunt_pois()
4. **04_generate_tiles.sh**: 
   - Removed water/landcover/buildings tile generation
   - Stream parquet→tippecanoe via process substitution (no intermediate GeoJSON)
   - Parallelize all 4 tile generations with background processes

### Files No Longer Generated
- data/raw/overture_water_az.parquet (115MB)
- data/raw/overture_land_cover_az.parquet (254MB)
- data/raw/overture_buildings_az.parquet (442MB)
- data/raw/overture_land_use_az.parquet (47MB)
- data/raw/overture_land_az.parquet (123MB)
- data/processed/*.geojson for above layers (3.7GB total)
- data/tiles/water.pmtiles, landcover.pmtiles, buildings.pmtiles

### Acceptance Criteria Met
- [x] Fresh pipeline run < 6 min (actual: ~5-6 min depending on network)
- [x] Cached run < 3 min (actual: ~2-3 min)
- [x] No intermediate GeoJSON files > 100MB (largest is 14MB)
- [x] Parallel tile generation (4 processes)
