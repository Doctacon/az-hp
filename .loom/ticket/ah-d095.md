---
"id": "ah-d095"
"status": "open"
"deps":
- "ah-2fa8"
"links": []
"created": "2026-02-18T02:02:14Z"
"type": "task"
"priority": 2
"assignee": "Connor"
"parent": "ah-174b"
"tags":
- "sprint:map-display-fix"
"external": {}
---
# Fix ArcGIS JSON format in BLM SMA data

# Fix ArcGIS JSON format in BLM SMA data

## Objective Alignment
The land ownership layer (`blm_sma_az.geojson`) must render correctly in MapLibre. ArcGIS exports use `rings` instead of standard GeoJSON `coordinates`, which MapLibre cannot parse.

## Scope
- Verify if BLM SMA data is in ArcGIS JSON format
- Convert ArcGIS JSON to standard GeoJSON format
- Update the download or enrich step to handle conversion automatically

## Non-goals
- Fix missing BLM/State Trust land (separate concern)
- Add new land ownership sources
- Modify frontend rendering code

## Implementation Plan

1. **Diagnose the issue** after pipeline runs:
   ```bash
   # Check if geometry uses 'rings' (ArcGIS format)
   uv run python -c "
   import json
   with open('data/raw/blm_sma_az.geojson') as f:
       data = json.load(f)
   if data['features']:
       geom = data['features'][0]['geometry']
       print('Geometry keys:', list(geom.keys()))
       if 'rings' in geom:
           print('ISSUE: ArcGIS format detected (uses rings)')
       elif 'coordinates' in geom:
           print('OK: Standard GeoJSON format')
   "
   ```

2. **If ArcGIS format detected**, add conversion to `pipeline/03_enrich.py` in `prepare_static_layers()`:
   ```python
   def convert_arcgis_to_geojson(arcgis_geom):
       """Convert ArcGIS rings to GeoJSON coordinates."""
       if 'rings' in arcgis_geom:
           return {
               'type': 'Polygon',
               'coordinates': arcgis_geom['rings']
           }
       return arcgis_geom
   
   # In prepare_static_layers():
   for feat in sma_gdf.iloc:
       feat.geometry = convert_arcgis_to_geojson(feat.geometry)
   ```

3. **Alternative**: Use geopandas which handles both formats:
   ```python
   # This already happens in 03_enrich.py when reading via gpd.read_file()
   # The issue may be in how we serialize it back
   sma_gdf.to_file(frontend_data / "blm_sma_az.geojson", driver="GeoJSON")
   ```

4. **Verify fix** by checking the output file structure

## Verification Commands
```bash
# After running make enrich, verify GeoJSON format
uv run python -c "
import json
with open('frontend/public/data/blm_sma_az.geojson') as f:
    data = json.load(f)
if data['features']:
    geom = data['features'][0]['geometry']
    assert 'coordinates' in geom, 'Missing coordinates field'
    assert 'rings' not in geom, 'Still has ArcGIS rings field'
    print('OK: Valid GeoJSON format')
"
```

## Acceptance Criteria
- [ ] `frontend/public/data/blm_sma_az.geojson` has valid GeoJSON geometry
- [ ] All features have `geometry.coordinates` (not `geometry.rings`)
- [ ] Land ownership layer renders in MapLibre without errors

## Risks/Edge Cases
- **Empty features**: Some features may have null geometry - handle gracefully
- **Multi-part polygons**: ArcGIS rings may represent multi-polygons - verify conversion
- **Attribute loss**: Ensure `ADMIN_AGENCY_CODE` is preserved for color matching

## Dependencies
- Requires: ah-2fa8 (Run full data pipeline) - needs raw data to check

## Acceptance Criteria

blm_sma_az.geojson has valid GeoJSON geometry with 'coordinates' field (not 'rings')
